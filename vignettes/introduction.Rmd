---
title: "Introduction to NAHRtoolkit"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{introductin}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  options(tibble.print_min = 4, tibble.print_max = 4)
)
```

```{r setup}
library(nahrtoolkit)
```

NAHRtoolkit provides functions to generate sequences with repetitive elements, 
invoke minimap2 to spot repeats and run tree-like algorithms to detect likely
repeat-mediated SVs. 

## Big weaknesses in implementation

bbmap shred.sh script is kinda needed but not properly installed/referred.


## Example use cases.

### `confirm_loaded_nahr()`: Check if loading has been successful

`nahrtoolkit::confirm_loaded_nahr()` Tests if loading has been successful.

```{r}
confirm_loaded_nahr()
```

### Use case 1: Make a dotplot visualisation of two fasta files. 


We start with creating two dotplots of a fasta file with itself. First, let us specify an example sequence.
(Note: the example sequence has been created from the commandline, using: 
Rscript seqbuilder_wrapper.R -l 10000 -s ../data/sds10y.tsv -o 10ktest
)

```{r}
samplefasta_link = system.file('extdata', '10ktest.fa', package='nahrtoolkit')
samplepaf_link = paste0(samplefasta_link, '.paf')
```

If the sequence is not too long, we can use an exact dotplot to visualize the ground truth.

```{r}

exact_plot = make_dotplot(samplefasta_link, samplefasta_link, 15, save=F)
print(exact_plot)
```

Alternatively, if the sequences are very long, we can also use Minimap2 to generate us a dotplot. Note how segdups are being highlighted. 

```{r, warning = FALSE, message = FALSE}

minimap2_inferred_plot = 
  make_chunked_minimap_alnment(samplefasta_link, samplefasta_link, samplepaf_link, 
                               chunklen = 500, saveplot=F, 
                               hllink = samplepaf_link, hltype = 'paf')


print(minimap2_inferred_plot)
```


### Use case 2: Sequence simulation and modification
#### 2.1: Simulate a sequence with SDs. 

NAHRtoolkit can also simulate a new sequence. What we need for this is a .tsv file containing specifications for the desired SDs. 

```{r, warning = FALSE, message = FALSE}

seqlen = 10000
sdfile_bed = system.file('extdata', 'sds10.bed', package='nahrtoolkit')
#sdfile_bed = '/Users/hoeps/PhD/projects/nahrcall/nahrchainer/seqbuilder/inst/extdata/sds10.bed'
outfasta = './simulated_seq_10kb.fa'

sdfile_tsv = './sds10.tsv'
# Turn the easy-to-write .bed file into a .tsv file 
convert_bed_to_tsv(sdfile_bed, sdfile_tsv)

## MAKE THE SEQUENCE
simulate_seq(seqlen, sdfile_tsv, outfasta)

# Make an exact dotplot, in case this is feasible.
if (seqlen <= 25000){
  exact_plot = make_dotplot(outfasta, outfasta, 15, save=F)
  print(exact_plot)
}
```

#### 2.2: Introduce mutations to a simulated sequence. 

We can use a simple text file with two columns [SDname, Operation] to specify mutations we would like to see. Let's start with a simple inversion:

```{r, warning = FALSE, message = FALSE}

#svfile_invA = '/Users/hoeps/PhD/projects/nahrcall/nahrchainer/seqbuilder/inst/extdata/SDa_inv.txt'
svfile_invA = system.file('extdata', 'SDa_inv.txt', package='nahrtoolkit')

outmutfasta = './simulated_seq_10kb_inv.fa'
outmutsd = './simulated_seq_10kb_inv.tsv'
mutate_seq(outfasta, sdfile_tsv, svfile_invA, outmutfasta, outmutsd)

if (seqlen <= 25000){
  exact_plot = make_dotplot(outfasta, outmutfasta, 15, save=F)
  print(exact_plot)
}
```

We can also make the same dotplot with alignments from minimap2: 

```{r, warning = FALSE, message = FALSE}
samplepaf_link ='./simulated_seq_10kb_mm2.paf'

make_chunked_minimap_alnment(outfasta, outmutfasta, samplepaf_link, 
                             chunklen = 5000, minsdlen = 0, saveplot=F, 
                             hllink = samplepaf_link, hltype = 'paf', quadrantsize = 500000)
```

Next, we initiate a more complex sequence with four SD pairs, and introduce various mutations.

```{r, warning = FALSE, message = FALSE}

seqlen = 10000
sdfile_tsv = system.file('extdata', 'sds10_4SDs.tsv', package='nahrtoolkit')
#sdfile_tsv = '/Users/hoeps/PhD/projects/nahrcall/nahrchainer/seqbuilder/inst/extdata/sds10_4SDs.tsv'
outfasta = './simulated_seq_10kb_4SDs.fa'


## MAKE THE SEQUENCE
simulate_seq(seqlen, sdfile_tsv, outfasta)

# Make an exact dotplot, in case this is feasible.
if (seqlen <= 25000){
  exact_plot = make_dotplot(outfasta, outfasta, 15, save=F)
  print(exact_plot + ggplot2::labs(title='Simulated Sequence #2. Four SD pairs.'))
}

# First: A deletion on SDC
#svfile_delC = '/Users/hoeps/PhD/projects/nahrcall/nahrchainer/seqbuilder/inst/extdata/SDc_del.txt'
svfile_delC = system.file('extdata', 'SDc_del.txt', package='nahrtoolkit')

outmutfasta = './simulated_seq_10kb_del.fa'
outmutsd = './simulated_seq_10kb_del.tsv'
mutate_seq(outfasta, sdfile_tsv, svfile_delC, outmutfasta, outmutsd)

if (seqlen <= 25000){
  exact_plot = make_dotplot(outfasta, outmutfasta, 15, save=F)
  print(exact_plot + ggplot2::labs(title='Seq #2, Mutation #1: deletion on SDC'))
}

# Next, let's duplicate on that same SD pair. 
#svfile_dupC = '/Users/hoeps/PhD/projects/nahrcall/nahrchainer/seqbuilder/inst/extdata/SDc_dup.txt'
svfile_dupC = system.file('extdata', 'SDc_dup.txt', package='nahrtoolkit')

outmutfasta = './simulated_seq_10kb_dup.fa'
outmutsd = './simulated_seq_10kb_dup.tsv'
mutate_seq(outfasta, sdfile_tsv, svfile_dupC, outmutfasta, outmutsd)

if (seqlen <= 25000){
  exact_plot = make_dotplot(outfasta, outmutfasta, 15, save=F)
  print(exact_plot + ggplot2::labs(title='Seq #2, Mutation #2: duplication on SDC'))
}
```
As a last example, let's create at a sequence with two nested SD pairs: 

```{r, warning = FALSE, message = FALSE}

seqlen = 10000
#sdfile_bed = '/Users/hoeps/PhD/projects/nahrcall/nahrchainer/seqbuilder/inst/extdata/sds_twonest.bed'
sdfile_bed = system.file('extdata', 'sds_twonest.bed', package='nahrtoolkit')

outfasta = './simulated_seq_twonest.fa'

sdfile_tsv = './sds_twonest.tsv'
# Turn the easy-to-write .bed file into a .tsv file 
convert_bed_to_tsv(sdfile_bed, sdfile_tsv)

## MAKE THE SEQUENCE
simulate_seq(seqlen, sdfile_tsv, outfasta)

# Make an exact dotplot, in case this is feasible.
if (seqlen <= 25000){
  exact_plot = make_dotplot(outfasta, outfasta, 15, save=F)
  print(exact_plot  + ggplot2::labs(title='Simulated Sequence #3. Two nested SD pairs in indirect orientation.'))
}
```

There are no SDs in direct orientation, hence no CNVs are possible right now. However, we could invert on one SD first, and then duplicate on the other. Let's try: 

```{r, warning = FALSE, message = FALSE}
#svfile_invA = '/Users/hoeps/PhD/projects/nahrcall/nahrchainer/seqbuilder/inst/extdata/SDa_inv.txt'
#svfile_dupB = '/Users/hoeps/PhD/projects/nahrcall/nahrchainer/seqbuilder/inst/extdata/SDb_dup.txt'

svfile_invA = system.file('extdata', 'SDa_inv.txt', package='nahrtoolkit')
svfile_dupB = system.file('extdata', 'SDb_dup.txt', package='nahrtoolkit')

outmutfasta = './simulated_seq_twonest_inv.fa'
outmutsd = './simulated_seq_twonest_inv.tsv'
outmutfasta2 = './simulated_seq_twonest_inv_dup.fa'
outmutsd2 = './simulated_seq_twonest_inv_dup.tsv'
# Notice how a dup on SDB is not possible upfront:
try(mutate_seq(outfasta, sdfile_tsv, svfile_dupB, outmutfasta, outmutsd))


mutate_seq(outfasta, sdfile_tsv, svfile_invA, outmutfasta, outmutsd)
mutate_seq(outmutfasta, outmutsd, svfile_dupB, outmutfasta2, outmutsd2)

# Let's have a look at the resulting sequence. We plot it against the orig seq. 

if (seqlen <= 25000){
  exact_plot = make_dotplot(outfasta, outmutfasta2, 15, save=F) + ggplot2::labs(title='Simulated Sequence #3. Double mutation: INV + DUP')
  print(exact_plot)
}
```


















